<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>File Manager</title>
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>

	<!-- for mobile devices -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, user-scalable=no" />

	<!-- For iOS devices -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="apple-touch-icon" sizes="57x57" href="apple-touch-icon-57x57-fm.png">
	<link rel="apple-touch-icon" sizes="76x76" href="apple-touch-icon-72x72-fm.png">
	<link rel="apple-touch-icon" sizes="114x114" href="apple-touch-icon-114x114-fm.png">
	<link rel="apple-touch-icon" sizes="144x144" href="apple-touch-icon-144x144-fm.png">

	<link rel="stylesheet" href="css/main.css">
</head>
<body>

<!--

1. Page
1.1. Header
1.1.1. Row1
1.1.1.1. Logo
1.1.1.2. Account
1.1.1.2.1. AccountId
1.1.1.2.2. SignOutButton
1.1.2. Row2
1.1.2.1. Navigation
1.1.2.1.1. UpButton
1.1.2.1.2. NavigationBar
1.1.2.2. Toolbar
1.1.2.2.1. CreateContainer
1.1.2.2.2. CreateDirectory
1.1.2.2.3. CreateFile
1.1.2.2.4. UploadFiles
1.1.2.2.5. UploadAs
1.1.2.2.6. Wide
1.1.3. Row3
1.1.3.1. CreateContainerForm
1.1.3.2. CreateDirectoryForm
1.1.3.3. CreateFileForm
1.2. NoContainers
1.3. NoFiles
1.4. List
1.5. Editor
2. Authentication

-->

<div id="Page">
	<div id="Header">
		<div id="Row1">
			<h1 id="Logo">File Manager</h1>
			<div id="Account">
				<label id="AccountId"></label>
				<button id="SignOut">Sign Out</button>
			</div>
		</div>
		<div id="Row2">
			<div id="Navigation">
				<button id="UpButton" class="toolbar-button" title="Up"></button>
				<label id="NavigationBar"></label>
			</div>
			<div id="Toolbar">
				<button id="CreateContainerButton" class="toolbar-button dialog-button" title="Create Container" data-action="container" data-placeholder="Create Container"></button>
				<button id="CreateDirectoryButton" class="toolbar-button dialog-button" title="Create Directory" data-action="directory" data-placeholder="Create Directory"></button>
				<button id="CreateFileButton" class="toolbar-button dialog-button" title="Create File" data-action="file" data-placeholder="Create File"></button>
				<span id="UploadFilesButton" class="toolbar-button input-wrapper" title="Upload Files"><input class="upload-input" type="file" multiple="multiple" data-action="file"/></span>
				<span id="UploadAsButton" class="toolbar-button input-wrapper" title="Upload As..."><input class="upload-input" type="file" multiple="multiple" data-action="as"/></span>
				<span id="UploadAndExecuteButton" class="toolbar-button input-wrapper" title="Upload & Execute"><input class="upload-input" type="file" data-action="exec"/></span>
				<button id="WideButton" class="toolbar-button always-enabled" title="Wide"></button>
			</div>
		</div>
		<div id="Row3">
			<form id="CreateContainerDialog" class="form dialog hidden">
				<input placeholder="Container Name">
				<div class="err-empty err hidden">Please type container name.</div>
				<div class="err-size-limit err hidden">Container name must be less than 256 bytes.</div>
				<div class="err-invalid-character err hidden">Container name cannot contain a forward slash '/' character.</div>
				<div class="err-ajax err hidden"></div>
				<div class="err-already-exists err hidden">Container already exists.</div>
				<button type="submit" class="btn btn-primary">Create</button>
				<button type="button" class="btn-cancel btn btn-primary">Cancel</button>
			</form>
			<form id="CreateDirectoryDialog" class="form dialog hidden">
				<input placeholder="Directory Name">
				<div class="err-empty err hidden">Please type directory name.</div>
				<div class="err-size-limit err hidden">Directory name must be less than 1024 bytes.</div>
				<div class="err-invalid-character err hidden">Directory name cannot contain a forward slash '/' character.</div>
				<div class="err-ajax err hidden"></div>
				<div class="err-already-exists err hidden">Directory already exists.</div>
				<button type="submit" class="btn btn-primary">Create</button>
				<button type="button" class="btn-cancel btn btn-primary">Cancel</button>
			</form>
			<form id="CreateFileDialog" class="form dialog hidden">
				<input placeholder="File Name">
				<div class="err-empty err hidden">Please type file name.</div>
				<div class="err-size-limit err hidden">File name must be less than 1024 bytes.</div>
				<div class="err-invalid-character err hidden">File name cannot contain a forward slash '/' character.</div>
				<div class="err-ajax err hidden"></div>
				<div class="err-already-exists err hidden">File already exists.</div>
				<button type="submit" class="btn btn-primary">Create</button>
				<button type="button" class="btn-cancel btn btn-primary">Cancel</button>
			</form>

			<div id="CreateDialog" class="hidden dialog">
				<form class="input-group">
					<input id="input_CreateContainerDialog" type="text" class="form-control">
					<div class="dialog-wrapper"></div>
				<span class="input-group-btn dialog-footer">
					<button id="OKDialog" class="btn btn-primary ok-dialog-button" type="submit">OK</button>
					<button id="CancelDialog" class="btn btn-default cancel-dialog-button" type="button">Cancel</button>
				</span>
				</form>
			</div>

			<div id="CopyDialog" class="hidden">
				<form class="input-group">
					<div class="input-wrapper hidden">
						<input type="text" class="form-control">
					</div>
					<div class="dialog-wrapper"></div>
				<span class="input-group-btn">
					<button class="btn btn-primary" type="submit">Copy all</button>
					<button class="btn btn-default" type="button">Cancel</button>
				</span>
				</form>
			</div>
			<div id="progressDialog">
			</div>

			<div id="mainProgressBar" class="hidden"></div>

			<div class="hidden err-msg-wrapper"><label class="err-msg"></label></div>
			<div class="menu-file dialog no-select">
				<button class="undo txt-btn" title="Undo"></button>
				<button class="redo txt-btn" title="Redo"></button>
				<button class="save txt-btn" title="Save"></button>
				<button class="save-as txt-btn" data-action="saveas" title="Save As..."></button>
				<button class="execute txt-btn" data-action="execute" title="Execute"></button>
				<button class="download-link txt-btn"></button>
				<div class="editor-toolbar-error" hidden>Error: <span class="status"></span>
					<span class="status-text"></span>.
				</div>
			</div>
		</div>
	</div>
	<div id="NoContainers" class="hidden">There are no containers.</div>
	<div id="NoFiles" class="hidden">There are no files.</div>
	<div id="AjaxError" class="hidden">Ajax Error: <span id="AjaxErrorMessage"></span> (<span id="AjaxStatusCode"></span>)</div>
	<div id="List">

		<div class="transition-div"></div>
		<div class="report-wrapper">
			<div class="timer-wrapper">
				<span class="pre-text"></span><span class="time-output">00</span>:<span class="time-output">00</span>
			</div>
			<div id="report" class="hidden"></div>
		</div>

		<template id="containerTemplate">
			<div class="item" title="{{title}}" data-path="{{path}}" data-type="container">
			<span class="left">
				<span class="file-type"></span>
				<label class="name">{{name}}</label>
			</span>
			<span class="right">
				<label class="size">{{size}}</label>
				<label class="files">{{files}}</label>
			</span>
				<button class="toggle-item-menu-btn btn"></button>
			</div>
		</template>

		<div class="template template-file item" title data-path data-type data-full-path data-content-type>
			<span class="left">
				<span class="file-type"></span>
				<label class="name"></label>
			</span>
			<span class="right">
				<label class="size"></label>
				<label class="modified"></label>
			</span>
			<button class="toggle-item-menu-btn btn"></button>
		</div>

		<template id="newTransitionDivTemplate">
			<div class="new-transition-div transition-div"></div>
		</template>

		<template id="transitionDivLoadingTemplate">
			<label class="transition-div-loading">Loading...</label>
		</template>

	</div>
	<div class="code-editor-wrapper">
		<div id="codeEditor"></div>
	</div>
</div>

<style>
	.full-stretch {
		position: absolute;
		left: 0;
		right: 0;
		top: 0;
		bottom: 0;
		overflow: auto;
	}
	.center-content {
		position: absolute;
		top: 50%;
		left: 50%;
		-webkit-transform: translateX(-50%) translateY(-50%);
		-moz-transform: translateX(-50%) translateY(-50%);
		-ms-transform: translateX(-50%) translateY(-50%);
		-o-transform: translateX(-50%) translateY(-50%);
		transform: translateX(-50%) translateY(-50%);
	}

	#v1AuthForm {
		z-index:999;
		background: url(img/cloud_left_top.png) left top, url(img/cloud_right_top.png) right top, url(img/cloud_left_bottom.png) left bottom, url(img/cloud_right_bottom.png) right bottom, #92AEC8;
		background-repeat: no-repeat;
		background-attachment: fixed;
	}

	#v1AuthForm label {
		cursor: default;
		color: white;
		font-size: medium;
		margin-top: 10px;
		margin-bottom: 2px;
		display: block;
	}

	#v1AuthForm input {
		font-size: small;
		line-height: 22px;
		width: 250px;
		padding: 0 5px;
	}

	#v1AuthForm button[type=submit] {
		margin-top: 10px;
		font-size: medium;
		padding: 5px 10px;
	}
</style>

<form id="v1AuthForm" class="full-stretch">
	<div class="center-content">
		<label>V1 AUTH URL: </label><input id="v1-auth-url" value=""><br>
		<label>Tenant: </label><input id="tenant"><br>
		<label>X Auth User: </label><input id="x-auth-user"><br>
		<label>X Auth Key: </label><input id="x-auth-key"><br>
		<button type="submit" class="btn">Submit</button>
	</div>
</form>


<script src="js/Swift.js"></script>

<script src="js/vendor/require.js"></script>
<script src="js/vendor/ace/ace.js"></script>
<script src="js/vendor/iscroll.js"></script>

<script>

	var FileManager;

	if (!FileManager) {
		FileManager = {};
	}

	FileManager.ENABLE_ZEROVM = true;

	FileManager.AjaxError = {};//TODO: replace it with errrorMsg

	FileManager.AjaxError.show = function (el, status, statusText) {
		el.querySelector('.status').textContent = status;
		el.querySelector('.status-text').textContent = statusText;
		el.removeAttribute('hidden');
	};

	function initPage() {
		location.hash = SwiftV1.account + "/";
		window.refreshItemList();

		FileManager.reAuth();

		document.getElementById("WideButton").addEventListener("click", function(){
			document.body.classList.toggle("wide-content");
		});
	}

	FileManager.reAuth = function () {
		SwiftV1.Account.head({success:function(){},error:function(){}});
		setTimeout(FileManager.reAuth, 1000 * 60 * 20);
	};

	window.onload = function () {
                auth_url = document.getElementById('v1-auth-url');
                if (auth_url.value == "") {
                  auth_url.value = document.location.protocol + "//" +
                    document.location.host + "/auth/v1.0";
                }

		messageForIE();

		function messageForIE() {
			if (navigator.userAgent.indexOf('MSIE') != -1) {
				document.body.innerHTML = '<h1 style="margin:5% auto; text-align: center;font-family: arial; color: #8b0000;">Internet Explorer is not supported. Please open in other browser.</h1>';
			}
		}
	};
</script>

<script src="js/Navigation.js"></script>
<script src="js/extendNative.js"></script>
<script src="js/toolbox.js"></script>
<script src="js/dialogForm.js"></script>
<script src="js/FileClick.js"></script>
<script src="js/item.js"></script>
<script src="js/uploadButtons.js"></script>
<script src="js/fileEditor.js"></script>
<script src="js/errorMsg.js"></script>
<script src="js/fileExecutor.js"></script>

<script>
function show_app() {
    toolbox();
    document.getElementById('v1AuthForm').setAttribute('hidden', 'hidden');
    document.getElementById('AccountId').textContent = SwiftV1.account;
    document.getElementById('SignOut').onclick = function () {
	window.location.reload(true);
	//document.getElementById('v1AuthForm').removeAttribute('hidden');
    };
    initPage();
    document.addEventListener('click', function (e) {
	var el;
	if (document.body.classList.contains('disabled')) {
	    return;
	}
	if (el = FileManager.toolbox.getParentByClassName(e.target,'toggle-item-menu-btn')) {
	    FileManager.item.toggleMenu(el);
	} else if (el = FileManager.toolbox.getParentByClassName(e.target,'item')) {
	    FileManager.item.click(el);
	} else if (window.FileManager.toolbox.getParentByClassName(e.target, 'load-more-button')) {
	    FilesList.loadMore();
	}
    });
    //setRootClass();
}

SwiftV1.loadValuesFromCookie();
SwiftV1.Account.head({"success": show_app, "error": function () {}});

	document.getElementById('v1AuthForm').onsubmit = function (e) {
		e.preventDefault();
		var v1AuthUrl = document.getElementById('v1-auth-url').value;
		var tenant = document.getElementById('tenant').value;
		var xAuthUser = document.getElementById('x-auth-user').value;
		var xAuthKey = document.getElementById('x-auth-key').value;
		SwiftV1.retrieveTokens({
			v1AuthUrl: v1AuthUrl,
			tenant: tenant,
			xAuthUser: xAuthUser,
			xAuthKey: xAuthKey,
			error: function () {
				alert(arguments[0] + ' ' + arguments[1]);
			},
			ok: show_app
		});
	};



	window.refreshItemList = function () {
		var parentEl, newEl, oldEl, template, el, loadingEl,
				commandName;

		commandName = window.FileManager.item.itemCommandName.pop();//added to prevent unnecessary request while change event fired on loaded file
		if (commandName === "none"){
			return;
		} else {
			window.FileManager.item.itemCommandName.set(commandName);
		}

		function animateItemListRefreshing() {
			oldEl.classList.add("old-transition-div");
			newEl.classList.remove("new-transition-div");
			document.getElementById('List').firstElementChild.scrollIntoView();
		}

		oldEl = document.getElementById('List').firstElementChild;
		parentEl = oldEl.parentNode;

		template = document.querySelector("#newTransitionDivTemplate").innerHTML;
		parentEl.insertAdjacentHTML("afterbegin", template);
		newEl = document.querySelector(".new-transition-div");

		el = newEl;
		NavigationBar.setContent(CurrentPath().withoutAccount(), true);

		if (CurrentPath().isContainersList()) {
			ContainersList.load(animateItemListRefreshing);
		} else if (CurrentPath().isFilesList()) {
			FilesList.load(animateItemListRefreshing);
		} else {
			handleFileClick(el, animateItemListRefreshing);
		}

		loadingEl = document.querySelector(".transition-div-loading");
		loadingEl && loadingEl.parentNode.removeChild(loadingEl);
	}

	window.ontransition = function (e) {
		var el = e.target ? e.target : e, newEl;
		if (el.classList.contains("old-transition-div")) {
			el.parentNode.removeChild(el);
			newEl = document.getElementById('List').firstElementChild;
			newEl.classList.add("no-transition");
			newEl.classList.remove("no-transition");
			document.body.classList.remove("disabled");
		}
	}

	document.addEventListener("transitionend", ontransition);
	document.addEventListener("webkitTransitionEnd", ontransition);
	window.addEventListener("hashchange", refreshItemList);

	document.getElementById('List').onscroll = function (e) {
		e = e.target ? e.target : e;
		if (Math.abs(e.scrollTop - (e.scrollHeight - e.clientHeight)) <= 1) {
			if (!document.body.classList.contains('loading-content')) {
				FilesList.loadMore();
			}
		}
	};
</script>

<script src="js/Toolbar.js"></script>

<script src="js/ContainersList.js"></script>
<script src="js/FilesList.js"></script>
<script src="js/CreateContainer.js"></script>
<script src="js/CreateDirectory.js"></script>
<script src="js/CreateFile.js"></script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.1.min.js"><\/script>')</script>

</body>
</html>
